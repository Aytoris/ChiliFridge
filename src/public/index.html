<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChiliFridge - Fridge & Recipe Manager</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="Manage your fridge inventory, recipes, and meal planning">
    <meta name="theme-color" content="#4CAF50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ChiliFridge">

    <!-- Styles and Icons -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="manifest" href="manifest.json">

    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="img/icon-192x192.svg">
    <link rel="apple-touch-icon" sizes="512x512" href="img/icon-512x512.svg">
</head>
<body>
    <!-- Calendar Section - Full width -->
    <div class="calendar-section">
        <h2>Meal Planner</h2>
        <div id="calendar" class="calendar-container"></div>
        <div class="form-group">
            <button id="addWeeklyGroceryListButton" class="btn-primary">Add Weekly Grocery List</button>
            <button id="exportMealPlanImageBtn" class="btn-export">Export Meal Plan Image</button>
            <button id="clearCalendarButton" class="btn-secondary">Clear Meal Planner</button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <div class="grocery">
            <h2>Grocery List</h2>
            <div class="form-group">
                <button id="toggleShoppingModeBtn">Enter Shopping Mode</button>
                <button id="exportGroceryBtn">Export Grocery List</button>
                <button id="clearGroceryBtn">Clear Grocery List</button>
                <button id="groceryMenuBtn" class="btn-secondary">â‹¯</button>
            </div>
            <!-- Hidden menu for additional options -->
            <div id="groceryMenu" class="grocery-menu" style="display: none;">
                <button id="sendToFridgeBtn">Add food to fridge</button>
                <button id="storeLayoutBtn">Store Layout</button>
                <button id="getGroceryLinksBtn">Get Grocery Website links</button>
            </div>
            <ul id="groceryList"></ul>
        </div>

        <div class="fridge">
            <h1>ChloÃ©'s Fridge</h1>
            <div class="form-group">
                <div class="autocomplete-container">
                    <input type="text" id="ingredientInput" list="ingredientList" placeholder="Select food" autocomplete="off">
                    <datalist id="ingredientList"></datalist>
                    <div id="autocompleteDropdown" class="autocomplete-dropdown"></div>
                </div>
                <label for="quantityInput">Quantity:</label>
                <input type="number" id="quantityInput" min="0.1" step="0.1" placeholder="Enter quantity" size="8" inputmode="decimal">
                <span id="unitDisplay"></span>
                <button id="toggleUnitBtn">Toggle Unit</button>
                <select id="ingredientCategorySelect">
                    <!-- Will be filled dynamically -->
                </select>
                <button id="addFoodBtn">Add</button>
            </div>

            <h2>Inventory</h2>
            <div class="fridge-controls">
                <button id="toggleFridgeCategoriesBtn">Hide Categories</button>
                <button id="editFridgeCategoriesBtn" class="btn-secondary">Edit Categories</button>
                <button id="clearFridgeBtn">Clear Fridge</button>
            </div>
            <ul id="fridgeList"></ul>

            <!-- Data Transfer Section -->
            <div class="data-transfer-section">
                <h3>Transfer Data</h3>
                <p class="transfer-description">Download all your data to transfer to another device</p>
                <div class="transfer-buttons">
                    <button id="downloadDataBtn" class="btn-primary">ðŸ“¥ Download All Data</button>
                    <button id="uploadDataBtn" class="btn-secondary">ðŸ“¤ Upload Data</button>
                    <input type="file" id="uploadDataInput" accept=".json" style="display: none;">
                </div>
            </div>
        </div>

        <div class="content">
            <h2>Cook a Meal</h2>
            <div class="form-group">
                <label for="mealSelect">Select a Meal:</label>
                <select id="mealSelect"></select>
                <button id="cookMealBtn">Cook</button>
                <label for="peopleCountMeal">Number of people: </label>
                <select id="peopleCountMeal">
                    <option value="1" selected>1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                </select>
            </div>

            <h2>Recipe Ingredients</h2>
            <ul id="recipeIngredients"></ul>

            <h2 style="color:red">Missing Ingredients</h2>
            <ul id="missingIngredients"></ul>
            <button id="addMissingBtn">Add All Missing Ingredients to Grocery List</button>
        </div>
    </div>

    <!-- Store Layout Modal (hidden by default) -->
    <div id="storeLayoutModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Store Layout Settings</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <p>Drag and drop categories to match your grocery store layout:</p>

                <ul id="storeSectionsList" class="sortable-list">
                    <!-- Will be filled dynamically -->
                </ul>

                <div class="form-group">
                    <button id="resetStoreLayout" class="btn-secondary">Reset to Default</button>
                    <button id="saveStoreLayout" class="btn-primary">Save Layout</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Fridge Categories Modal (hidden by default) -->
    <div id="fridgeCategoriesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Fridge Storage Locations</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <p>Drag and drop categories to match your kitchen storage locations:</p>

                <div id="fridgeCategoriesModalList" class="sortable-list">
                    <!-- Will be filled dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Cooking Mode Modal (hidden by default) -->
    <div id="cookingModeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="cookingModeTitle">Cooking Mode</h3>
                <span class="close-modal" id="closeCookingMode">&times;</span>
            </div>
            <div class="modal-body">
                <div class="cooking-mode-container">
                    <div class="recipe-details">
                        <h4>Ingredients</h4>
                        <div class="serving-info">
                            <span>Servings: </span><span id="cookingModeServingsDisplay">1</span>
                        </div>
                        <ul id="cookingModeIngredients" class="cooking-ingredients-list"></ul>

                        <!-- Timers Section -->
                        <div id="cookingTimersSection" class="cooking-timers-section">
                            <h4>Timers</h4>
                            <div id="cookingTimersContainer" class="timers-container"></div>
                        </div>
                    </div>
                    <div class="recipe-instructions">
                        <h4>Instructions</h4>
                        <div id="cookingModeInstructions" class="cooking-instructions"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- API Module -->
    <script src="js/recipesData.js"></script>
    <script src="js/api.js"></script>

    <!-- Utility Module -->
    <script src="js/utility.js"></script>

    <!-- Feature Modules -->
    <script src="js/storeCategoriesData.js"></script>
    <script src="js/fridge.js"></script>
    <script src="js/meal.js"></script>
    <script src="js/grocery.js"></script>
    <script src="js/calendar.js"></script>

    <!-- Sortable Library for drag-and-drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>

    <!-- html2canvas Library for exporting calendar as image -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <!-- Main Script -->
    <script>
        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then((registration) => {
                        console.log('Service Worker registered successfully:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }

        // Initialize all modules when the DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing modules');
            console.log('ChiliFridge - Client-Side PWA (No Server Required)');

            // Make sure modules don't throw errors if other modules are not ready
            window.onerror = function(message, source, lineno, colno, error) {
                console.log('Error caught:', message);
                // Return true to prevent the error from being displayed in the console
                return true;
            };

            // Initialize modules in proper sequence with error handling
            try {
                // First initialize MealModule which others depend on
                MealModule.init().catch(err => console.log('MealModule init error:', err));

                // Then initialize other modules with small delays to ensure proper order
                setTimeout(() => {
                    try { FridgeModule.init(); } catch (e) { console.log('FridgeModule init error:', e); }
                }, 100);

                setTimeout(() => {
                    try { GroceryModule.init(); } catch (e) { console.log('GroceryModule init error:', e); }
                }, 200);

                setTimeout(() => {
                    try { CalendarModule.init(); } catch (e) { console.log('CalendarModule init error:', e); }
                }, 300);
            } catch (e) {
                console.log('Module initialization error:', e);
            }

            console.log('All modules initialization started');

            // Set up data transfer event listeners
            setupDataTransfer();
        });

        /**
         * Set up data transfer functionality
         */
        function setupDataTransfer() {
            const downloadBtn = document.getElementById('downloadDataBtn');
            const uploadBtn = document.getElementById('uploadDataBtn');
            const uploadInput = document.getElementById('uploadDataInput');

            // Download data button
            if (downloadBtn) {
                downloadBtn.addEventListener('click', () => {
                    try {
                        const result = API.exportAllData();
                        if (result.success) {
                            Utility.showToast('Data downloaded successfully!', 'success');
                        } else {
                            Utility.showToast('Download failed: ' + result.message, 'error');
                        }
                    } catch (error) {
                        console.error('Error downloading data:', error);
                        Utility.showToast('Download failed', 'error');
                    }
                });
            }

            // Upload data button (triggers file input)
            if (uploadBtn) {
                uploadBtn.addEventListener('click', () => {
                    uploadInput.click();
                });
            }

            // Handle file selection
            if (uploadInput) {
                uploadInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    try {
                        Utility.showToast('Importing data...', 'info');
                        const result = await API.importAllData(file);

                        if (result.success) {
                            Utility.showToast(result.message, 'success');

                            // Reload the page after a short delay to apply all changes
                            setTimeout(() => {
                                window.location.reload();
                            }, 1500);
                        } else {
                            Utility.showToast('Import failed: ' + result.message, 'error');
                        }
                    } catch (error) {
                        console.error('Error importing data:', error);
                        Utility.showToast('Import failed: ' + error.message, 'error');
                    }

                    // Reset the file input so the same file can be selected again
                    e.target.value = '';
                });
            }
        }
    </script>

    <!-- Toast Notification Container -->
    <div id="toast-container"></div>
</body>
</html>